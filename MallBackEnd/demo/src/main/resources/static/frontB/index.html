<!DOCTYPE html>
<html lang="zh-CN">
<head>
  <meta charset="UTF-8">
  <title>ToB åå°ç®¡ç†ç³»ç»Ÿ</title>

  <script src="https://unpkg.com/vue@3/dist/vue.global.js"></script>
  <script src="https://unpkg.com/axios/dist/axios.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/echarts/dist/echarts.min.js"></script>

  <style>
    body { margin: 0; font-family: Arial; }

    /* ===== ç™»å½•é¡µ ===== */
    .login-wrapper {
      height: 100vh;
      display: flex;
      justify-content: center;
      align-items: center;
      background: #34495e;
    }

    .login-box {
      width: 300px;
      padding: 30px;
      background: #fff;
      border-radius: 6px;
      text-align: center;
    }

    .login-box input {
      width: 100%;
      margin: 10px 0;
      padding: 8px;
    }

    .login-box button {
      width: 100%;
      padding: 8px;
      background: #1abc9c;
      color: #fff;
      border: none;
      cursor: pointer;
    }

    /* ===== åå°å¸ƒå±€ ===== */
    .layout { display: flex; height: 100vh; }

    .sidebar {
      width: 190px;
      background: #2c3e50;
      padding: 10px;
      box-sizing: border-box;
    }

    .menu-title {
      color: #fff;
      font-weight: bold;
      text-align: center;
      margin-bottom: 10px;
    }

    .sidebar button {
      width: 100%;
      padding: 8px;
      margin: 6px 0;
      border: none;
      background: #34495e;
      color: white;
      cursor: pointer;
    }

    .sidebar button:hover { background: #1abc9c; }

    .content {
      flex: 1;
      padding: 20px;
      overflow-y: auto;
      box-sizing: border-box;
    }

    table {
      width: 100%;
      border-collapse: collapse;
      margin-top: 10px;
    }

    th, td {
      border: 1px solid #ccc;
      padding: 8px;
      text-align: center;
    }

    th { background: #f5f5f5; }

    .pagination { margin-top: 10px; }

    button { padding: 5px 10px; margin: 3px; }

    input { padding: 4px; width: 120px; margin: 0 5px; }

    img { max-width: 60px; max-height: 60px; }

    .edit-box {
      border: 1px solid #aaa;
      padding: 10px;
      margin: 10px 0;
      background: #fafafa;
    }

    .box {
      border: 1px solid #ddd;
      padding: 15px;
      margin-top: 10px;
    }
  </style>
</head>

<body>
<div id="app">

  <!-- ç™»å½•é¡µé¢ -->
  <div v-if="!isLogin" class="login-wrapper">
    <div class="login-box">
      <h2>åå°ç®¡ç†ç³»ç»Ÿç™»å½•</h2>
      <input v-model="loginForm.username" placeholder="ç”¨æˆ·å">
      <input v-model="loginForm.password" type="password" placeholder="å¯†ç ">
      <button type="button" @click="login">ç™»å½•</button>
      <p style="color:#888;font-size:12px;">è´¦å·ï¼šadmin / 123456</p>
    </div>
  </div>

  <!-- åå°ç³»ç»Ÿ -->
  <div v-else class="layout">

    <!-- å·¦ä¾§èœå• -->
    <div class="sidebar">
      <div class="menu-title">åå°ç®¡ç†</div>
      <button @click="currentModule='product'">ğŸ“¦ å•†å“ç®¡ç†</button>
      <button @click="currentModule='order'">ğŸ“„ è®¢å•ç®¡ç†</button>
      <button @click="currentModule='stat'">ğŸ“Š é”€å”®ç»Ÿè®¡</button>
      <button @click="currentModule='customer'">ğŸ‘¤ å®¢æˆ·ç®¡ç†</button>
      <button @click="currentModule='log'">ğŸ§¾ è¡Œä¸ºæ—¥å¿—</button>
      <button @click="logout">ğŸšª é€€å‡ºç™»å½•</button>
    </div>

    <!-- å³ä¾§å†…å®¹ -->
    <div class="content">

      <!-- å•†å“ç®¡ç† -->

      <div v-show="currentModule==='product'">
        <h2>ğŸ“¦ å•†å“åº“å­˜ç®¡ç†</h2>
        <button @click="loadProducts">æŸ¥è¯¢å•†å“</button>

        <div class="edit-box">
          å•†å“å <input v-model="newProduct.name">
          ä»·æ ¼ <input type="number" v-model="newProduct.price">
          åº“å­˜ <input type="number" v-model="newProduct.stock">
          å›¾ç‰‡ <input type="file" @change="handleImageChange">
          <button @click="addProduct">æ–°å¢</button>
        </div>

       <table>
          <tr>
            <th>ID</th>
            <th>åç§°</th>
            <th>ä»·æ ¼</th>
            <th>åº“å­˜</th>
            <th>å›¾ç‰‡</th>
            <th>æ“ä½œ</th>
          </tr>

          <tr v-for="p in productPageData" :key="p.id">
            <td>{{ p.id }}</td>

            <!-- åç§° -->
            <td>
              <input v-if="editProductId === p.id" v-model="editProduct.name">
              <span v-else>{{ p.name }}</span>
            </td>

            <!-- ä»·æ ¼ -->
            <td>
              <input v-if="editProductId === p.id" type="number" v-model="editProduct.price">
              <span v-else>{{ p.price }}</span>
            </td>

            <!-- åº“å­˜ -->
            <td>
              <input v-if="editProductId === p.id" type="number" v-model="editProduct.stock">
              <span v-else>{{ p.stock }}</span>
            </td>

            <!-- å›¾ç‰‡ -->
            <td>
              <img v-if="p.image" :src="p.image">
            </td>

            <!-- æ“ä½œæŒ‰é’® -->
            <td>
              <button v-if="editProductId !== p.id" @click="startEdit(p)">ä¿®æ”¹</button>
              <button v-if="editProductId !== p.id" @click="deleteProduct(p.id)">åˆ é™¤</button>

              <button v-if="editProductId === p.id" @click="saveEdit">ä¿å­˜</button>
              <button v-if="editProductId === p.id" @click="cancelEdit">å–æ¶ˆ</button>
            </td>
          </tr>
        </table>


        <div class="pagination">
          <button :disabled="productPage===1" @click="productPage--">ä¸Šä¸€é¡µ</button>
          ç¬¬ {{productPage}} / {{productTotalPages}} é¡µ
          <button :disabled="productPage===productTotalPages" @click="productPage++">ä¸‹ä¸€é¡µ</button>
        </div>
      </div>

      <!-- è®¢å•ç®¡ç† -->
      <div v-show="currentModule==='order'">
        <h2>ğŸ“„ è®¢å•ç®¡ç†</h2>
        <button @click="loadOrders">æŸ¥è¯¢è®¢å•</button>

        <table>
          <tr>
            <th>ID</th><th>ç”¨æˆ·</th><th>é‡‘é¢</th><th>çŠ¶æ€</th><th>æ—¶é—´</th>
          </tr>
          <tr v-for="o in orderPageData" :key="o.id">
            <td>{{o.id}}</td>
            <td>{{o.userId}}</td>
            <td>{{o.totalPrice}}</td>
            <td>{{o.status}}</td>
            <td>{{formatDate(o.createdAt)}}</td>
          </tr>
        </table>

        <div class="pagination">
          <button :disabled="orderPage===1" @click="orderPage--">ä¸Šä¸€é¡µ</button>
          ç¬¬ {{orderPage}} / {{orderTotalPages}} é¡µ
          <button :disabled="orderPage===orderTotalPages" @click="orderPage++">ä¸‹ä¸€é¡µ</button>
        </div>
      </div>

      <!-- é”€å”®ç»Ÿè®¡ -->
      <div v-show="currentModule==='stat'">
        <h2>ğŸ“Š é”€å”®ç»Ÿè®¡</h2>
        <button @click="loadStatistics">åˆ·æ–°ç»Ÿè®¡</button>
        <div class="box">
          <div id="productPie" style="height:400px;"></div>
          <div id="dailyLine" style="height:400px;margin-top:20px;"></div>
        </div>
      </div>

      <!-- å®¢æˆ·ç®¡ç† -->
      <div v-show="currentModule==='customer'">
        <h2>ğŸ‘¤ å®¢æˆ·ç®¡ç†</h2>
        <button @click="loadCustomers">æŸ¥è¯¢å®¢æˆ·</button>
        <table>
          <tr><th>ID</th><th>ç”¨æˆ·å</th><th>é‚®ç®±</th></tr>
          <tr v-for="c in customers" :key="c.id">
            <td>{{c.id}}</td>
            <td>{{c.username}}</td>
            <td>{{c.email}}</td>
          </tr>
        </table>
      </div>

      <!-- è¡Œä¸ºæ—¥å¿— -->
      <div v-show="currentModule==='log'">
        <h2>ğŸ§¾ å®¢æˆ·è¡Œä¸ºæ—¥å¿—</h2>
        <button @click="loadLogs">æŸ¥è¯¢æ—¥å¿—</button>

        <table>
          <tr><th>ID</th><th>è¡Œä¸º</th><th>å•†å“</th><th>æ—¶é—´</th></tr>
          <tr v-for="l in logPageData" :key="l.id">
            <td>{{l.id}}</td>
            <td>{{l.action}}</td>
            <td>{{l.productId}}</td>
            <td>{{formatDate(l.time)}}</td>
          </tr>
        </table>

        <div class="pagination">
          <button :disabled="logPage===1" @click="logPage--">ä¸Šä¸€é¡µ</button>
          ç¬¬ {{logPage}} / {{logTotalPages}} é¡µ
          <button :disabled="logPage===logTotalPages" @click="logPage++">ä¸‹ä¸€é¡µ</button>
        </div>
      </div>

    </div>
  </div>
</div>

<script>
const { createApp } = Vue
createApp({
  data() {
  return {
    baseUrl: window.location.origin,

    // ä¿è¯ isLogin æ˜¯å¸ƒå°”å€¼
    isLogin: localStorage.getItem('isLogin') === 'true' ? true : false,

    loginForm: { username: '', password: '' },
    currentModule: 'product',
    products: [], productPage: 1, productPageSize: 5,
    orders: [], orderPage: 1, orderPageSize: 5,
    customers: [],
    logs: [], logPage: 1, logPageSize: 5,
    productSales: [], dailySales: [],
    newProduct: { name:'', price:null, stock:null },
    editProductId: null,
    editProduct: { id: null, name: '', price: null, stock: null }
  }
},

  computed:{
    productTotalPages(){ return Math.ceil(this.products.length/this.productPageSize)||1 },
    orderTotalPages(){ return Math.ceil(this.orders.length/this.orderPageSize)||1 },
    logTotalPages(){ return Math.ceil(this.logs.length/this.logPageSize)||1 },

    productPageData(){
      const s=(this.productPage-1)*this.productPageSize
      return this.products.slice(s,s+this.productPageSize)
    },
    orderPageData(){
      const s=(this.orderPage-1)*this.orderPageSize
      return this.orders.slice(s,s+this.orderPageSize)
    },
    logPageData(){
      const s=(this.logPage-1)*this.logPageSize
      return this.logs.slice(s,s+this.logPageSize)
    }
  },

  watch:{
    currentModule(val){
      if(val==='stat'){
        this.$nextTick(()=>{
          this.renderProductPie()
          this.renderDailyLine()
        })
      }
    }
  },

  methods:{
    login() {
      console.log('ç‚¹å‡»äº†ç™»å½•æŒ‰é’®')  // éªŒè¯äº‹ä»¶æ˜¯å¦è§¦å‘
      if (this.loginForm.username === 'admin' && this.loginForm.password === '123456') {
        this.isLogin = true
        localStorage.setItem('isLogin', 'true')
      } else {
        alert('ç”¨æˆ·åæˆ–å¯†ç é”™è¯¯')
      }
    },
    logout(){
      this.isLogin = false
      localStorage.removeItem('isLogin')
      this.loginForm.username=''
      this.loginForm.password=''
    },

        // å¼€å§‹ç¼–è¾‘
    startEdit(p) {
      this.editProductId = p.id
      this.editProduct = { ...p }   // æ·±æ‹·è´ä¸€ä»½
    },

    // å–æ¶ˆç¼–è¾‘
    cancelEdit() {
      this.editProductId = null
      this.editProduct = { id:null, name:'', price:null, stock:null }
    },

    // ä¿å­˜ä¿®æ”¹
    saveEdit() {
      axios.put(this.baseUrl + '/api/products/update', this.editProduct)
        .then(() => {
          alert('ä¿®æ”¹æˆåŠŸ')
          this.editProductId = null
          this.loadProducts()
        })
    },

    // åˆ é™¤å•†å“
    deleteProduct(id) {
      if (!confirm('ç¡®è®¤åˆ é™¤è¯¥å•†å“å—ï¼Ÿ')) return

      axios.delete(this.baseUrl + '/api/products/delete/' + id)
        .then(() => {
          alert('åˆ é™¤æˆåŠŸ')
          this.loadProducts()
        })
    },

    addProduct() {
      const formData = new FormData()
      formData.append('name', this.newProduct.name)
      formData.append('price', this.newProduct.price)
      formData.append('stock', this.newProduct.stock)

      if (this.newProduct.imageFile) {
        formData.append('image', this.newProduct.imageFile) // åç«¯å­—æ®µ image
      }

      axios.post(this.baseUrl + '/api/products/add', formData, {
        headers: { 'Content-Type': 'multipart/form-data' }
      }).then(() => {
        alert('æ–°å¢æˆåŠŸ')
        this.loadProducts()
        this.newProduct = { name:'', price:null, stock:null, imageFile:null }
      })
    },
    loadProducts(){
      axios.get(this.baseUrl+'/api/products/AllProducts')
        .then(r=>this.products=r.data.list||r.data)
    },
    loadOrders(){
      axios.get(this.baseUrl+'/api/orders').then(r=>{
        this.orders=r.data
        this.orderPage=1
      })
    },
    loadCustomers(){
      axios.get(this.baseUrl+'/api/customers').then(r=>this.customers=r.data)
    },
    loadLogs(){
      axios.get(this.baseUrl+'/api/customers/logs').then(r=>{
        this.logs=r.data
        this.logPage=1
      })
    },
    loadStatistics(){
      axios.get(this.baseUrl+'/api/orders/product-sales')
        .then(r=>{this.productSales=r.data;this.renderProductPie()})
      axios.get(this.baseUrl+'/api/orders/daily-sales')
        .then(r=>{this.dailySales=r.data;this.renderDailyLine()})
    },
    renderProductPie(){
  echarts.init(document.getElementById('productPie')).setOption({
    title: {
      text: 'å„å•†å“é”€é‡å æ¯”',  // æ–°å¢æ ‡é¢˜
      left: 'center',
      top: 10,
      textStyle: { fontSize: 16 }
    },
    tooltip: { trigger: 'item' },
    series:[
      {
        type:'pie',
        radius:'60%',
        data:this.productSales.map(i=>({name:i.productName,value:i.count}))
      }
    ]
  })
},

    renderDailyLine(){
      echarts.init(document.getElementById('dailyLine')).setOption({
        title: {
          text: 'æ¯æ—¥é”€å”®é¢è¶‹åŠ¿',  // æ–°å¢æ ‡é¢˜
          left: 'center',
          top: 10,
          textStyle: { fontSize: 16 }
        },
        tooltip: { trigger: 'axis' },
        xAxis:{ type:'category', data:this.dailySales.map(i=>i.date) },
        yAxis:{ type:'value' },
        series:[{ type:'line', smooth:true, data:this.dailySales.map(i=>i.total) }]
      })
    },

    formatDate(t){
      return t?new Date(t).toLocaleString():''
    }
  }
}).mount('#app')
</script>

</body>
</html>
