<!DOCTYPE html>
<html lang="zh-CN">
<head>
  <meta charset="UTF-8">
  <title>ToB åå°ç®¡ç†ç³»ç»Ÿ</title>

  <script src="https://unpkg.com/vue@3/dist/vue.global.js"></script>
  <script src="https://unpkg.com/axios/dist/axios.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/echarts/dist/echarts.min.js"></script>

  <style>
    body { font-family: Arial; margin: 20px; }
    h2 { margin-top: 40px; }
    table { width: 100%; border-collapse: collapse; margin-top: 10px; }
    th, td { border: 1px solid #ccc; padding: 8px; text-align: center; }
    th { background: #f5f5f5; }
    button { padding: 5px 10px; margin: 3px; }
    .box { border: 1px solid #ddd; padding: 15px; margin-top: 10px; }
    .pagination { margin-top: 10px; }
    .edit-box {
      border: 1px solid #aaa;
      padding: 10px;
      margin-top: 10px;
      background: #fafafa;
    }
    input { padding: 4px; width: 120px; margin: 0 5px; }
    img { max-width: 60px; max-height: 60px; }
  </style>
</head>

<body>
<div id="app">

  <!-- ================= å•†å“åº“å­˜ç®¡ç† ================= -->
  <h2>ğŸ“¦ å•†å“åº“å­˜ç®¡ç†</h2>
  <button @click="loadProducts">æŸ¥è¯¢å•†å“</button>

  <div class="edit-box">
    <h3>â• æ–°å¢å•†å“</h3>
    å•†å“å <input v-model="newProduct.name">
    ä»·æ ¼ <input type="number" v-model="newProduct.price">
    åº“å­˜ <input type="number" v-model="newProduct.stock"><br><br>

    å•†å“å›¾ç‰‡
    <input type="file" @change="handleImageChange">

    <div v-if="imagePreview">
      <br>
      <img :src="imagePreview">
    </div>

    <br><br>
    <button @click="addProduct">æ–°å¢</button>
    <button @click="resetNewProduct">æ¸…ç©º</button>
  </div>

  <table>
    <tr>
      <th>ID</th><th>å•†å“å</th><th>ä»·æ ¼</th><th>åº“å­˜</th><th>å›¾ç‰‡</th><th>æ“ä½œ</th>
    </tr>
    <tr v-for="p in productPageData" :key="p.id">
      <td>{{ p.id }}</td>
      <td>{{ p.name }}</td>
      <td>{{ p.price }}</td>
      <td>{{ p.stock }}</td>
      <td><img v-if="p.imageUrl" :src="p.imageUrl"></td>
      <td>
        <button @click="editProduct(p)">ä¿®æ”¹</button>
        <button @click="deleteProduct(p.id)">åˆ é™¤</button>
      </td>
    </tr>
  </table>

  <div class="pagination">
    <button :disabled="productPage===1" @click="productPage--">ä¸Šä¸€é¡µ</button>
    <span>ç¬¬ {{productPage}} / {{productTotalPages}} é¡µ</span>
    <button :disabled="productPage===productTotalPages" @click="productPage++">ä¸‹ä¸€é¡µ</button>
  </div>

  <div class="edit-box" v-if="editingProduct">
    <h3>âœ ä¿®æ”¹å•†å“</h3>
    å•†å“å <input v-model="editingProduct.name">
    ä»·æ ¼ <input type="number" v-model="editingProduct.price">
    åº“å­˜ <input type="number" v-model="editingProduct.stock"><br><br>
    <button @click="updateProduct">ä¿å­˜</button>
    <button @click="editingProduct=null">å–æ¶ˆ</button>
  </div>

  <!-- ================= è®¢å•ç®¡ç† ================= -->
  <h2>ğŸ“„ è®¢å•ç®¡ç†</h2>
  <button @click="loadOrders">æŸ¥è¯¢è®¢å•</button>

  <table>
    <tr>
      <th>ID</th><th>ç”¨æˆ·ID</th><th>æ€»é‡‘é¢</th><th>çŠ¶æ€</th>
      <th>ç”µè¯</th><th>åœ°å€</th><th>æ—¶é—´</th>
    </tr>
    <tr v-for="o in orderPageData" :key="o.id">
      <td>{{o.id}}</td>
      <td>{{o.userId}}</td>
      <td>{{o.totalPrice}}</td>
      <td>{{o.status}}</td>
      <td>{{o.phone}}</td>
      <td>{{o.address}}</td>
      <td>{{formatDate(o.createdAt)}}</td>
    </tr>
  </table>

  <div class="pagination">
    <button :disabled="orderPage===1" @click="orderPage--">ä¸Šä¸€é¡µ</button>
    <span>ç¬¬ {{orderPage}} / {{orderTotalPages}} é¡µ</span>
    <button :disabled="orderPage===orderTotalPages" @click="orderPage++">ä¸‹ä¸€é¡µ</button>
  </div>

  <!-- ================= é”€å”®ç»Ÿè®¡ ================= -->
  <h2>ğŸ“Š é”€å”®ç»Ÿè®¡</h2>
  <button @click="loadStatistics">åˆ·æ–°ç»Ÿè®¡</button>

  <div class="box">
    <div id="productPie" style="width:100%;height:400px;"></div>
    <div id="dailyLine" style="width:100%;height:400px;margin-top:30px;"></div>
  </div>

  <!-- ================= å®¢æˆ·ç®¡ç† ================= -->
  <h2>ğŸ‘¤ å®¢æˆ·ç®¡ç†</h2>
  <button @click="loadCustomers">æŸ¥è¯¢å®¢æˆ·</button>
  <table>
    <tr><th>ID</th><th>ç”¨æˆ·å</th><th>é‚®ç®±</th></tr>
    <tr v-for="c in customers" :key="c.id">
      <td>{{c.id}}</td>
      <td>{{c.username}}</td>
      <td>{{c.email}}</td>
    </tr>
  </table>

  <!-- ================= å®¢æˆ·æ—¥å¿—ï¼ˆåˆ†é¡µï¼‰ ================= -->
  <h2>ğŸ§¾ å®¢æˆ·è¡Œä¸ºæ—¥å¿—</h2>
  <button @click="loadLogs">æŸ¥è¯¢æ—¥å¿—</button>

  <table>
    <tr><th>ID</th><th>è¡Œä¸º</th><th>å•†å“</th><th>æ—¶é—´</th></tr>
    <tr v-for="l in logPageData" :key="l.id">
      <td>{{l.id}}</td>
      <td>{{l.action}}</td>
      <td>{{l.productId}}</td>
      <td>{{formatDate(l.time)}}</td>
    </tr>
  </table>

  <div class="pagination">
    <button :disabled="logPage===1" @click="logPage--">ä¸Šä¸€é¡µ</button>
    <span>ç¬¬ {{logPage}} / {{logTotalPages}} é¡µ</span>
    <button :disabled="logPage===logTotalPages" @click="logPage++">ä¸‹ä¸€é¡µ</button>
  </div>

</div>

<script>
const { createApp } = Vue
createApp({
  data() {
    return {
      baseUrl: 'http://localhost:8080',

      products: [], productPage: 1, productPageSize: 5,
      editingProduct: null,
      newProduct: { name:'', price:null, stock:null },
      imageFile:null, imagePreview:null,

      orders: [], orderPage:1, orderPageSize:5,

      productSales: [], dailySales: [],

      customers:[],
      logs:[], logPage:1, logPageSize:5
    }
  },

  computed:{
    productTotalPages(){
      return Math.ceil(this.products.length/this.productPageSize)||1
    },
    productPageData(){
      const s=(this.productPage-1)*this.productPageSize
      return this.products.slice(s,s+this.productPageSize)
    },

    orderTotalPages(){
      return Math.ceil(this.orders.length/this.orderPageSize)||1
    },
    orderPageData(){
      const s=(this.orderPage-1)*this.orderPageSize
      return this.orders.slice(s,s+this.orderPageSize)
    },

    logTotalPages(){
      return Math.ceil(this.logs.length/this.logPageSize)||1
    },
    logPageData(){
      const s=(this.logPage-1)*this.logPageSize
      return this.logs.slice(s,s+this.logPageSize)
    }
  },

  methods:{
    loadProducts(){ /* åŸé€»è¾‘ä¸å˜ */ 
      axios.get(this.baseUrl + '/api/products/AllProducts')
        .then(r=>{
          const list=r.data.list||r.data
          this.products=list.map(p=>{
            let img=p.imageUrl||p.image||p.imgUrl||''
            if(img && !img.startsWith('http')) img=this.baseUrl+img
            return {...p,imageUrl:img}
          })
        })
    },

    loadOrders(){
      axios.get(this.baseUrl+'/api/orders')
        .then(r=>{this.orders=r.data;this.orderPage=1})
    },

    loadLogs(){
      axios.get(this.baseUrl+'/api/customers/logs')
        .then(r=>{
          this.logs=r.data
          this.logPage=1
        })
    },

    loadCustomers(){
      axios.get(this.baseUrl+'/api/customers')
        .then(r=>this.customers=r.data)
    },

    loadStatistics(){
      this.loadProductSales()
      this.loadDailySales()
    },

    loadProductSales(){
      axios.get(this.baseUrl+'/api/orders/product-sales')
        .then(r=>{this.productSales=r.data;this.renderProductPie()})
    },

    loadDailySales(){
      axios.get(this.baseUrl+'/api/orders/daily-sales')
        .then(r=>{this.dailySales=r.data;this.renderDailyLine()})
    },

    renderProductPie(){
      echarts.init(document.getElementById('productPie')).setOption({
        title:{text:'å•†å“é”€é‡å æ¯”',left:'center'},
        series:[{type:'pie',radius:'60%',data:this.productSales.map(i=>({name:i.productName,value:i.count}))}]
      })
    },

    renderDailyLine(){
      echarts.init(document.getElementById('dailyLine')).setOption({
        title:{text:'æ¯æ—¥é”€å”®é¢è¶‹åŠ¿'},
        xAxis:{type:'category',data:this.dailySales.map(i=>i.date)},
        yAxis:{type:'value'},
        series:[{type:'line',smooth:true,data:this.dailySales.map(i=>i.total)}]
      })
    },

    formatDate(t){
      return t?new Date(t).toLocaleString():''
    }
  }
}).mount('#app')
</script>

</body>
</html>
